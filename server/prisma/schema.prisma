generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Game {
  id          String   @id @default(cuid())
  title       String
  description String
  rating      Float    @default(5)
  tags        String[]
  author      String
  coverUrl    String
  rules       String
  gallery     String[]
  editions    Edition[]
  // Сценарий: дополнительные поля
  worldRules       String?    // правила мира (краткая версия для UI, до 500 символов)
  gameplayRules    String?    // правила игрового процесса (краткая версия для UI, до 500 символов)
  worldRulesFull   String?    @db.Text // полные правила мира для ИИ (не отображаются в UI) - DEPRECATED: используй worldRulesPdfPath
  gameplayRulesFull String?   @db.Text // полные правила игрового процесса для ИИ (не отображаются в UI) - DEPRECATED: используй gameplayRulesPdfPath
  worldRulesPdfPath String?    // путь к PDF файлу с правилами мира (хранится на диске)
  gameplayRulesPdfPath String? // путь к PDF файлу с правилами игрового процесса (хранится на диске)
  scenarioPdfPath  String?    // путь к PDF файлу со сценарием (хранится на диске)
  introduction     String?    // введение
  backstory        String?    // предыстория
  adventureHooks   String?    // зацепки приключения
  vkVideoUrl       String?    // ссылка на VK видео
  promoDescription String?    // рекламное описание
  marketplaceLinks String[]   // ссылки на маркетплейсы
  shelfCategory    ShelfCategory? // категория на полке
  shelfPosition    Int?       // позиция на полке
  bannerStyle      BannerStyle?   // стиль баннера на главной
  ageRating        AgeRating?     // возрастной рейтинг
  authorUserId     String?    // автор (пользователь)
  status           GameStatus @default(DRAFT) // статус публикации
  winCondition     String?    // условие победы
  loseCondition    String?    // условие поражения
  deathCondition   String?    // условие смерти
  finalScreenUrl   String?    // финальная заставка
  usePregenMaterials Boolean  @default(false) // использовать прегенерированные материалы (текст и аудио)

  // Отношения
  locations    Location[]
  characters   Character[]
  ruleChunks   RuleChunk[] // Чанки правил для RAG
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Edition {
  id          String  @id @default(cuid())
  name        String
  description String
  price       Int
  badge       String?
  gameId      String
  game        Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)
}

model User {
  id                String   @id @default(cuid())
  firstName         String
  lastName          String
  tgUsername        String?
  tgId              String?
  subscriptionType  String?
  status            String   @default("active")
  registeredAt      DateTime @default(now())
  balance           Int      @default(0)
  referralsCount    Int      @default(0)
  subscriptionUntil DateTime?
  lastSeenAt        DateTime?
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  gameId    String?
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
}

// Сохранённые сессии чата
model ChatSession {
  id        String   @id @default(cuid())
  userId    String
  gameId    String
  history   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, gameId])
}

// Дружба/добавления
model FriendEdge {
  id        String       @id @default(cuid())
  userId    String
  friendId  String
  status    FriendStatus @default(ACCEPTED)
  createdAt DateTime     @default(now())

  @@unique([userId, friendId])
}

enum FriendStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

// Приглашение в друзья по коду (для TG ссылки)
model FriendInvite {
  code      String   @id // компактный код для ссылки
  inviterId String
  usedById  String?
  createdAt DateTime @default(now())
  expiresAt DateTime?
  usedAt    DateTime?
}

// Лобби на 2-4 игроков
model GameLobby {
  id         String       @id @default(cuid())
  gameId     String?
  hostUserId String
  status     LobbyStatus  @default(OPEN)
  maxPlayers Int          @default(4)
  members    LobbyMember[]
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

model LobbyMember {
  id       String     @id @default(cuid())
  lobbyId  String
  userId   String
  role     LobbyRole  @default(PLAYER)
  joinedAt DateTime   @default(now())
  lobby    GameLobby  @relation(fields: [lobbyId], references: [id], onDelete: Cascade)

  @@unique([lobbyId, userId])
}

enum LobbyStatus {
  OPEN
  RUNNING
  CLOSED
}

enum LobbyRole {
  HOST
  PLAYER
}

// Локации (уровни/главы)
model Location {
  id           String   @id @default(cuid())
  gameId       String
  game         Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  order        Int
  title        String
  description  String?
  rulesPrompt  String?
  backgroundUrl String?
  layout       Json?
  musicUrl     String?
  exits        LocationExit[]
}

// Переходы/триггеры локации (кнопки и правила сцены)
model LocationExit {
  id             String   @id @default(cuid())
  locationId     String
  location       Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  type           ExitType  @default(BUTTON) // BUTTON | TRIGGER | GAMEOVER
  buttonText     String?   // подпись кнопки (если type=BUTTON)
  triggerText    String?   // ключевое действие/фраза (если type=TRIGGER)
  targetLocationId String? // куда перейти (null, если GAMEOVER)
  isGameOver     Boolean   @default(false) // финал (проигрыш/победа) — не переходим
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

enum ExitType {
  BUTTON
  TRIGGER
  GAMEOVER
}

// Игровая сессия (Директор ведёт текущее состояние)
model GameSession {
  id             String    @id @default(cuid())
  scenarioGameId String    // используем существующую модель Game как «сценарий»
  lobbyId        String?   // общее состояние в лобби
  userId         String?   // либо соло-сессия
  currentLocationId String
  state          Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

// Чанки правил для RAG (Retrieval Augmented Generation)
model RuleChunk {
  id            String   @id @default(cuid())
  gameId        String   // ID игры
  chunkType     String   // 'worldRules' или 'gameplayRules'
  chunkIndex    Int      // Порядковый номер чанка
  content       String   @db.Text // Содержимое чанка
  keywords      String[] // Ключевые слова для быстрого поиска (локации, персонажи, механики)
  summary       String?  @db.Text // Краткое резюме чанка для семантического поиска
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  game          Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  @@unique([gameId, chunkType, chunkIndex])
  @@index([gameId, chunkType])
}

// Персонажи (игровые и NPC)
model Character {
  id          String   @id @default(cuid())
  gameId      String?
  game        Game?    @relation(fields: [gameId], references: [id], onDelete: SetNull)
  name        String
  gender      String?
  race        String?
  avatarUrl   String
  description String?
  abilities   String?
  rating      Float?
  role        String?  // роль персонажа (для игровых персонажей)
  voiceId     String?  // идентификатор голоса
  persona     String?  // характер/манера общения
  origin      String?  // происхождение/история
  isPlayable  Boolean  @default(false) // игровой персонаж или NPC
  
  // D&D 5e Stats
  level       Int      @default(1)
  class       String?  // Class (Fighter, Wizard, etc.)
  hp          Int      @default(10)
  maxHp       Int      @default(10)
  ac          Int      @default(10) // Armor Class
  str         Int      @default(10) // Strength
  dex         Int      @default(10) // Dexterity
  con         Int      @default(10) // Constitution
  int         Int      @default(10) // Intelligence
  wis         Int      @default(10) // Wisdom
  cha         Int      @default(10) // Charisma
  skills      Json?    // Proficient skills
  inventory   Json?    // Items, weapons, gold
  spells      Json?    // Known/Prepared spells
  equipment   Json?    // Current equipment
}

// Статусы игры
enum GameStatus {
  DRAFT
  TEST
  PUBLISHED
}

// Возрастной рейтинг
enum AgeRating {
  G0
  G6
  G12
  G16
  G18
}

// Категории полки на главной
enum ShelfCategory {
  MAIN
  NEW
  POPULAR
  FANTASY
  TEAM
  PUZZLE
}

// Варианты баннера
enum BannerStyle {
  DEFAULT
  WIDE
  TALL
  VIDEO
}


